# Система пожарно-охранной сигнализации "Фобос".

## Состав.

1. Микросервисная архитектура, с протоколом авторизации OAuth2. Состоит из следующих микросервисов:
   - Сервер авторизации
   - Менеджер сервисов Eureka, для регистрации микросервисов
   - Шлюз (Gateway API)
   - Микросервис Storage, отвечающий за БД объектов и ответственных лиц.
   - Микросервис Logger, для записи протокола обмена оператора и оборудования.
   - Микросервис Rs232Dev, для обмена данными с удаленным оборудованием через порт RS-232.
   - Микросервис Transfer, посредник между микросервисами *Dev и клиентским ПО, в частности АРМ.
   - Микросервис Notification, рассылка уведомлений ответственным лицам.
   - Микросервис Web-client, предоставляющий веб-интерфейс для баз данных.
2. АРМ - автоматизированное рабочее место оператора. Десктопное GUI-приложение, написанное на Swing, расположенное удаленно от сервера. 
3. Модуль для работы с Rs-232, подключаемый через Native Interface.


## База данных. Сущности.

Состоит из:
1) ObjectEntity - база данных для описания наблюдаемых объектов. 
2) Person - база данных для персонала и ответственных лиц.
3) WorkSchedule - база данных возможных графиков работы для персонала и режимов работы для цехов.  
4) Phone - телефоны.

Связи между этими БД ограничены, что позволяет разрывать связи без
удаления ранее связанных данных. Сделано это для того, чтобы редактировать
эти БД независимо друг от друга. 

WorkSchedule - это ограниченный набор режимов работы, который не нужно удалять
при удалении связанных с ним других сущностей, поскольку набор этот довольно консервативен, меняется
редко. Носит чисто информативный, для оператора, характер, поэтому выполнена максимально просто.

Phone, помимо информационной составляющей для персонала и объектов, может играть роль 
справочника телефонов для всего предприятия. 

В Person, помимо ответственных лиц, можно хранить данные вообще о любых сотрудниках. 
Иногда это бывает нужно оператору, когда ответственное лицо должен подменить кто-то другой. И
будет лучше, если данные об этом другом будут в БД и сохранятся там на будущее (даже после
открепления от объекта), если вновь придется давать ему временный допуск к объекту.

## База данных. Установка MySQL.

В папке `Dockerconfig/mysql` собираем контейнер:
```shell
docker-compose up -d
```
Файл `init.sql`, что рядом с docker-compose.yml, обеспечит создание всех необходимых баз данных.

Файл `.env` задает переменные среды окружения, что будут переданы в контейнер.

Проверяем установилось ли:
```shell
docker ps
```
Для разработки использование файла .env довольно удобно, но для продакшена
лучше использовать docker secrets.

## RabbitMQ.

Устанавливаем контейнер:
```shell
docker run -d --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:management
```
Порт 5672 — стандартный порт для AMQP-протокола.

Порт 15672 — для веб-интерфейса RabbitMQ Management.

Админка соответственно: http://localhost:15672

Пароль и логин: `guest`


## Запуск сервера.
1. Auth-server
2. Eureka-server
3. Все остальные.


### Разное (пока не актуально).
Генерация приватного ключа для сервера аутентификации:
```shell
openssl genrsa -out private_key.pem 2048
```
Извлечение публичного ключа из приватного:
```shell
openssl rsa -in private_key.pem -pubout -out public_key.pem
```
По необходимости конвертируем первичный ключ из формата PKCS#1 в PKCS#8:
```shell
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in private_key.pem -out private_key_pkcs8.pem
```
